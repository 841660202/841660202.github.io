---
title: ä¼ä¸šå¾®ä¿¡æ–‡ä»¶é¢„è§ˆ
date: 2022-07-05 23:16:30
categories: ä¼ä¸šå¾®ä¿¡
tags: [ä¼ä¸šå¾®ä¿¡]
cover:
---

## ä¼ä¸šå¾®ä¿¡æ–‡ä»¶é¢„è§ˆ

**è¯•é”™ 1:**

```ts
const fileName = "xxxxx.jpeg"; // ä¸¾ä¸ªä¾‹å­
downloadAttachment(downloadUrl).then((res) => {
  var reader = new FileReader();
  reader.readAsDataURL(res); // è½¬æ¢ä¸ºbase64ï¼Œå¯ä»¥ç›´æ¥æ”¾å…¥aæ ‡ç­¾href
  reader.onload = function (e) {
    const anchorEle = document.createElement("a");
    document.body.appendChild(anchorEle);
    anchorEle.href = e?.target?.result as any;
    anchorEle.download = fileName;
    anchorEle.click();
    setTimeout(() => {
      document.body.removeChild(anchorEle);
    });
  };
});
```

**è¯•é”™ 2: file-saver**

**è¯•é”™ 3: file-saver**

```ts
export const downloadFile = (target, filename = "", type = "url") => {
  const link = document.createElement("a");
  const body = document.querySelector("body");
  if (!body) return;

  // éœ€ä¸‹è½½çš„æ–‡ä»¶ç±»å‹
  if (type === "url") {
    link.href = target;
  } else if (type === "blob") {
    link.href = window.URL.createObjectURL(target);
  }

  // æ–‡ä»¶å
  if (filename) link.download = filename;

  link.style.display = "none";
  body.appendChild(link);

  link.click();

  window.URL.revokeObjectURL(link.href); // é‡Šæ”¾ URL å¯¹è±¡
  body.removeChild(link);
};
```

åœ¨æµè§ˆå™¨ä¸Šæ²¡é—®é¢˜ï¼Œåœ¨ä¼ä¸šå¾®ä¿¡ä¸Š`å—å±ï½`ï¼Œæœ‰äººè¦è¯´äº†ï¼Œç›´æ¥`window.open(downloadUrl)`,é€šå¸¸æ¥è¯´æ²¡æ¯›ç—…ã€‚

**å¯æ˜¯**ï¼Œè¦åœ¨è¯·æ±‚`downloadUrl`æ¥å£æ—¶å€™è¦åŠ ä¸€ä¸ªè¯·æ±‚å¤´ï¼Œè¿™å°¼ç›æ•´çš„ï½

<img src="http://t-blog-images.aijs.top/img/20220705223754.webp" />

## è¿™åœºæ™¯çœŸ ğŸ¶

ä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¥‡è‘©çš„äº‹æƒ…å‘¢ï¼Ÿâ€”â€” ç»§ä¹‹å‰ï¼Œå¯¹åŒä¸€ä¸ªåŸŸåï¼Œä»¥è¯·æ±‚å¤´åŒºåˆ†æ˜¯**ä¼ä¸šå¾®ä¿¡**ã€**éä¼ä¸šå¾®ä¿¡**ï¼Œä¸¤ç§ç¯å¢ƒçš„æˆæƒæ ¡éªŒæ–¹å¼ä¸åŒã€‚æœ¬èº«æ¶‰åŠæ²¡ä½¿ç”¨ userAgent,è®¾è®¡ç¼ºé™·ï¼Œå¯¼è‡´ä¸€è¿ä¸²é—®é¢˜ã€‚

é—®ï¼š`ä½ æ€ä¹ˆä¸é‡æ„ï¼Ÿ` ç­”ï¼š`éƒ¨é—¨éƒ½è¢«è£äº†ï¼Œæˆ‘å†åŠªåŠ›æœ‰ç”¨å—ï¼Ÿ`

## è§£å†³æ–¹æ¡ˆ

æ–¹æ¡ˆ 1: æŒ‰ç…§ä¹‹å‰çš„è®¾è®¡ï¼Œå†ç”³è¯·ä¸ªåŸŸåï¼ŒæŒ‰ç…§åŸŸåæŠŠåº”ç”¨æ‹†åˆ†ï¼ˆ`è¿™ä¸ªè¦èµ°å®¡æ ¸`ï¼‰

æ–¹æ¡ˆ 2: åç«¯å¤„ç†ç”¨`userAgent`å¤„ç†ä¸‹ï¼Œå…¶ä»–åœ°æ–¹é€»è¾‘ä¸åŠ¨ï¼Œåªå¤„ç† a æ ‡ç­¾ä¸‹è½½çš„æƒ…å†µï¼ˆ`è¿™ä¸ªè¦åç«¯æ”¹---æ²¡æƒé™æˆ‘è§‰å¾—æˆ‘è‡ªå·±æ”¹æˆ–è®¸æ›´å¿«`ï¼‰

æ–¹æ¡ˆ 3: æŠŠ API æ”¹äº†ï¼Œå“ªé‡Œå‡ºé—®é¢˜æ”¹å“ªé‡Œ `api/wx/download` ç»™è¿™ä¸ªå¢åŠ è¯·æ±‚å¤´ï¼Œ ä»£ç†åˆ° `api/download`ï¼ˆ`è¿™é‡Œåº”è¯¥ä¼šå¸¦è¿‡æ¥è¯·æ±‚å¤´`ï¼‰

```ts
let fileUrl =
  "themis/attach/download?cloudKey=" +
  attachment.themisCloudKey +
  "&fileName=" +
  encodeURIComponen(attachment.name);
// ä¼ä¸šå¾®ä¿¡
if (getWechatUserAgent(navigator.userAgent)) {
  downloadFile(`/api/redline/wx/${fileUrl}`);
  // éä¼ä¸šå¾®ä¿¡
} else {
  downloadFile(`/api/redline/${fileUrl}`);
}
```

<img src="http://t-blog-images.aijs.top/img/20220706000557.webp" />

<img src="http://t-blog-images.aijs.top/img/20220706000652.webp" />

å“ˆå“ˆï½ï¼Œå¼€å¿ƒï½
