---
title: piniaæºç åˆ†æ playground
date: 2022-06-13 15:27:26
categories: vue
tags: [vue, æºç ]
cover: http://t-blog-images.aijs.top/img/20220610172420.webp
---

## playground è¿è¡Œ

æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ vue é¡¹ç›®


## package.json

```json
  "scripts": {
    "release": "node scripts/release.mjs",
    "size": "pnpm run -r size",
    "build": "pnpm run -r build",
    "docs:build": "pnpm run docs:api && pnpm run -r docs:build --filter ./packages/docs",
    "play": "pnpm run -r play",
    "build:dts": "pnpm run -r build:dts --parallel",
    "lint": "prettier -c --parser typescript \"packages/*/{src,__tests__,e2e}/**/*.[jt]s?(x)\"",
    "lint:fix": "pnpm run lint --write",
    "test": "pnpm run test:types && pnpm run test:jest && pnpm run -r test && pnpm run build && pnpm run build:dts && pnpm test:dts",
    "test:jest": "jest --coverage",
    "test:types": "tsc --build ./tsconfig.json",
    "test:dts": "pnpm run -r test:dts",
    "docs:api": "pnpm run -r docs:api --filter ./packages/docs"
  }

```

## å®‰è£…

:::warning

æ³¨æ„ node ç‰ˆæœ¬ `The engine "node" is incompatible with this module. Expected version "^12.20.0 || ^14.13.1 || >=16.0.0".`

```bash
ğŸ‘‘ ~/Desktop/pinia git:(v2) $ yarn
 yarn install v1.4.0

     node/14.17.4
   Î¿ node/15.14.0
     node/16.13.1

 Use up/down arrow keys to select a version, return key to install, d to delete, q to quit
 info No lockfile found.
 [1/4] ğŸ”  Resolving packages...
 warning conventional-changelog-cli > tempfile > uuid@3.4.0: Please upgrade  to version 7 or higher.  Older versions may use Math.random() in certain circumstances, which is known to be problematic.  See https://v8.dev/blog/math-random for details.
 warning workspace-aggregator-d3702d10-5118-458d-9b17-8c5b340f31d0 > @pinia/nuxt > @nuxt/types > @types/autoprefixer > @types/browserslist@4.15.0: This is a stub types definition. browserslist provides its own type definitions, so you do not need this installed.
 warning workspace-aggregator-d3702d10-5118-458d-9b17-8c5b340f31d0 > @pinia/nuxt > @nuxt/types > @types/webpack > @types/anymatch@3.0.0: This is a stub types definition. anymatch provides its own type definitions, so you do not need this installed.
 [2/4] ğŸšš  Fetching packages...
 error execa@6.1.0: The engine "node" is incompatible with this module. Expected version "^12.20.0 || ^14.13.1 || >=16.0.0".
 error An unexpected error occurred: "Found incompatible module".
 info If you think this is a bug, please open a bug report with the information provided in "/Users/haotian/Desktop/pinia/yarn-error.log".
 info Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.
 ğŸ‘‘ ~/Desktop/pinia git:(v2) $ sudo n
 Password:
   installed : v16.13.1 (with npm 8.1.2)
```

:::

```bash
# å…¨å±€å®‰è£…pnpm
npm install -g pnpm

# æ ¹ç›®å½•
yarn
```

## è¿è¡Œ

```bash
yarn build && yarn play
```

:::tip

å¦‚æœä¸è¿è¡Œ `yarn build`,ä½ å°†çœ‹åˆ°å¦‚ä¸‹æŠ¥é”™ä¿¡æ¯ï¼ŒåŸå› æ˜¯`playgound/vite.config.ts`ï¼Œå†…éƒ¨å†™äº†`copyPiniaPlugin`

[plugin:vite:import-analysis] Failed to resolve entry for package "pinia". The package may have incorrect main/module/exports specified in its package.json: Failed to resolve entry for package "pinia". The package may have incorrect main/module/exports specified in its package.json
:::

## playgound/vite.config.ts

```ts
import { defineConfig, Plugin } from "vite";
import vue from "@vitejs/plugin-vue";
import { promises as fs } from "fs";
import path from "path";

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [vue(), copyPiniaPlugin()],
  define: {
    // __DEV__: 'true',
    // __BROWSER__: 'true',
    __TEST__: "false",
  },
  resolve: {
    // alias: {
    //   '@vue/composition-api': 'vue-demi',
    // },
    dedupe: ["vue-demi", "vue"],
  },
  optimizeDeps: {
    // piniaé¡¹æ’é™¤
    exclude: ["vue-demi", "@vueuse/shared", "@vueuse/core", "pinia"],
  },
});
// æ‹·è´piniaåˆ°é¡¹ç›®ä¸­ï¼Œé¿å…ç¼–è¯‘
function copyPiniaPlugin(): Plugin {
  return {
    name: "copy-pinia",
    async generateBundle() {
      const filePath = path.resolve(__dirname, "../pinia/dist/pinia.mjs"); // æ³¨æ„è¿™é‡Œï¼Œä¸æ‰§è¡Œ yarn build è¿™é‡Œæ˜¯æ²¡æœ‰æ•°æ®çš„ï¼Œyarn playä¼šæŠ¥é”™

      // throws if file doesn't exist
      await fs.access(filePath);

      this.emitFile({
        type: "asset",
        fileName: "pinia.mjs",
        source: await fs.readFile(filePath, "utf-8"),
      });
    },
  };
}
```

![](http://t-blog-images.aijs.top/img/20220613184319.webp)

## playground/index.html

```html
<!DOCTYPE html>
<!-- htmlè§£æè§„åˆ™-->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- å…³é”®å­—ç¬¦é›† -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- æ–¹ä¾¿æ‰‹æœºç«¯è°ƒæ•´åˆ†è¾¨ç‡ -->
    <title>ğŸ Pinia playground</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1/new.min.css"
    />
    <link rel="stylesheet" href="https://fonts.xz.style/serve/inter.css" />
    <!-- ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯ é¦–å±ä¼˜åŒ–ï¼ŒåŠ è½½åŠ¨ç”» è¿è¡Œåå‘ç°ï¼Œå¹¶ä¸æ˜¯ï¼Œä»…ä»…æ˜¯æ ·å¼è€Œå·²ï¼Œä»£ç ä¸­ä½¿ç”¨v-if æˆ–v-else-ifæ¸²æŸ“åŠ è½½åŠ¨ç”»-->
    <!-- 
      JokesPromised.vue 
      NasaPOD.vue 
      NasaPODwrc.vue 
    -->
    <style>
      @keyframes spinner {
        to {
          transform: rotate(360deg);
        }
      }

      .spinner:before {
        content: "";
        box-sizing: border-box;
        position: absolute;
        top: 50%;
        left: 50%;
        width: 30px;
        height: 30px;
        margin-top: -15px;
        margin-left: -15px;
        border-radius: 50%;
        border: 1px solid #ccc;
        border-top-color: #07d;
        animation: spinner 0.6s linear infinite;
      }
    </style>
  </head>
  <body>
    <!-- vueæ ¹èŠ‚ç‚¹ -->
    <div id="app"></div>
    <!-- æ¨¡å—åŠ è½½ -->
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
```

## api ç›®å½•

ä¸€äº›å°ç»ƒä¹ ï¼Œdemo ä¹‹ç±»çš„ä¸œè¥¿ï¼Œæˆ‘æœ‰ç‚¹ä¸æ˜ç™½çš„æ˜¯ï¼Œ`pinia/packages/playground/src/api`ä¸‹ä½¿ç”¨äº†`mande`,ä¸èƒ½ç›´æ¥ç”¨`fetch`å—?

- `mande`**Requires fetch support.**
- Weekly Downloads 530 ğŸ˜“
- Unpacked Size 47.3 kB
  > ä¸ºäº†ç‚«æŠ€è€Œå†™çš„ï¼Œæ‰€ä»¥æˆ‘æ²¡æœ‰ç”¨`fetch`ï¼Œè€Œæ˜¯ç”¨äº†`mande`ã€‚â€”â€”æ­¤å¤„ AI è‡ªåŠ¨ç”Ÿæˆ

## composables ç›®å½•

```ts
// useCachedRequest.ts
// pinia/packages/playground/src/composables/useCachedRequest.ts

export function useCachedRequest<T, U>(
  keySource: Ref<U>,
  getter: (key: U) => Promise<T> // è¿™åº”è¯¥æ˜¯ä¸€ä¸ªæ¥å£
) {
  const data = ref<T>(); // å­˜æ•°æ®
  const isLoading = ref(false); // åŠ è½½åŠ¨ç”»
  const isReady = ref(false); // æ˜¯å¦å·²åŠ è½½æ•°æ®
  const error = ref<Error | undefined>(); // æœ‰æ²¡æœ‰å‡ºé”™

  const cache = new Map<U, T>(); // ä½¿ç”¨mapå®ç°ç¼“å­˜

  onScopeDispose(() => {
    // æ¸…ç†ç¼“å­˜
    cache.clear();
  });

  watchEffect(async () => {
    const key = unref(keySource);
    isReady.value = false; // æ˜¯ä¸æ˜¯å·²æ‹¿åˆ°æ•°æ®
    isLoading.value = true; // åŠ è½½åŠ¨ç”»

    if (cache.has(key)) {
      data.value = cache.get(key)!;
      isReady.value = true;
    }

    getter(key)
      .then((newData) => {
        cache.set(key, newData);
        data.value = newData;
        isReady.value = true;
      })
      .catch((err) => {
        error.value = err;
      })
      .finally(() => {
        isLoading.value = false;
      });
  });

  return { data, error, isLoading, isReady }; // æœ€åå°†è¿™äº›å€¼è¿”å›
}
```

<hr/>

<h2 style="text-aligin:center">å°æ’æ›²</h2>

**onScopeDispose**

è¿™ä¸ª api æ²¡è§è¿‡ï¼Œæœä¸‹å…¶ä»–äººæ˜¯æ€ä¹ˆç†è§£çš„

åœ¨ vue3.2 ä¸­æ–°å¢äº†ä¸€ä¸ªå±æ€§ EffectScopeï¼Œå®˜æ–¹æ–‡æ¡£çš„è§£é‡Šæ¯”è¾ƒç®€å•ï¼Œåªè¯´æ˜¯ä¸€ä¸ªé«˜çº§å±æ€§ï¼Œå¹¶æ²¡æœ‰å…·ä½“çš„ç¤ºä¾‹ã€‚

antfu å¤§ç¥çš„ vueuse æ¡†æ¶æºç ï¼Œé‡Œé¢å¤§é‡ä½¿ç”¨ EffectScopeï¼Œæ‰€ä»¥ç ”ç©¶äº†ä¸€ä¸‹è¿™ä¸ªå±æ€§çš„ä½¿ç”¨æ–¹æ³•ã€‚

## ä»€ä¹ˆæ˜¯ EffectScope?

ä¸‹é¢æ˜¯å®˜æ–¹æ–‡æ¡£è§£é‡Šï¼Œæ„Ÿè§‰æœ‰ç‚¹æ•·è¡

Effect scope is an advanced API primarily intended for library authors. For details on how to leverage this API, please consult its corresponding RFC(opens new window).
è¿™ä¸ª api æ˜¯é«˜çº§çš„ï¼Œä¸»è¦ç”¨äºåº“çš„å¼€å‘è€…ã€‚æ›´å¤šè¯¦æƒ…ï¼Œè¯·å‚è€ƒå…¶å¯¹åº”çš„ RFC(æ–°çª—å£æ‰“å¼€)ã€‚

RFC å…³äº EffectScopeApi çš„è§£é‡Š

åœ¨ Vue çš„ setup ä¸­ï¼Œå“åº”ä¼šåœ¨å¼€å§‹åˆå§‹åŒ–çš„æ—¶å€™è¢«æ”¶é›†ï¼Œåœ¨å®ä¾‹è¢«å¸è½½çš„æ—¶å€™ï¼Œå“åº”å°±ä¼šè‡ªåŠ¨çš„è¢«å–æ¶ˆè¿½è¸ªäº†ï¼Œè¿™æ—¶ä¸€ä¸ªå¾ˆæ–¹ä¾¿çš„ç‰¹æ€§ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬åœ¨ç»„ä»¶å¤–ä½¿ç”¨æˆ–è€…ç¼–å†™ä¸€ä¸ªç‹¬ç«‹çš„åŒ…æ—¶ï¼Œè¿™ä¼šå˜å¾—éå¸¸éº»çƒ¦ã€‚å½“åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬è¯¥**å¦‚ä½•åœæ­¢ computed & watch çš„å“åº”å¼ä¾èµ–å‘¢ï¼Ÿ**

å®é™…ä¸Š EffectScope æŒ‰æˆ‘çš„ç†è§£å°±æ˜¯å‰¯ä½œç”¨ç”Ÿæ•ˆçš„ä½œç”¨åŸŸã€‚

vue3 å¯¹å“åº”å¼çš„ç›‘å¬æ˜¯é€šè¿‡ effect å®ç°çš„ï¼Œå½“æˆ‘ä»¬çš„ç»„ä»¶é”€æ¯çš„æ—¶å€™ vue ä¼šè‡ªåŠ¨å–æ¶ˆè¯¥ç»„ä»¶çš„ effectã€‚

é‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³è¦è‡ªå·±æ§åˆ¶ effect ç”Ÿæ•ˆä¸å¦å‘¢ï¼Ÿ æ¯”å¦‚æˆ‘åªæƒ³åœ¨è«ç§ç‰¹å®šæƒ…å†µä¸‹æ‰ç›‘å¬æ‘¸ä¸ª refï¼Œå…¶ä»–æƒ…å†µä¸‹ä¸æƒ³ç›‘å¬è¯¥æ€ä¹ˆåšï¼Ÿ

vue3.2 ä¹‹å‰

```ts
//ï¼ˆvue-RFCç¤ºä¾‹ä»£ç ï¼‰
const disposables = [];

const counter = ref(0);
const doubled = computed(() => counter.value * 2);

disposables.push(() => stop(doubled.effect));

const stopWatch1 = watchEffect(() => {
  console.log(`counter: ${counter.value}`);
});

disposables.push(stopWatch1);

const stopWatch2 = watch(doubled, () => {
  console.log(doubled.value);
});

disposables.push(stopWatch2);
```

## EffectScope å¦‚ä½•å®ç°

```ts
// effect, computed, watch, watchEffect created inside the scope will be collected

const scope = effectScope();

scope.run(() => {
  const doubled = computed(() => counter.value * 2);

  watch(doubled, () => console.log(doubled.value));

  watchEffect(() => console.log("Count: ", doubled.value));
});

// to dispose all effects in the scope
scope.stop();
```

ç¤ºä¾‹;

```ts
const scope = effectScope();
let counter = ref(0);
setInterval(() => {
  counter.value++;
}, 1000);
scope.run(() => {
  watchEffect(() => console.log(`counter: ${counter.value}`));
});
/*log:
counter: 0
counter: 1
counter: 2
counter: 3
counter: 4
counter: 5
*/
```

```ts
const scope = effectScope();
let counter = ref(0);
setInterval(() => {
  counter.value++;
}, 1000);
scope.run(() => {
  watchEffect(() => console.log(`counter: ${counter.value}`));
});
scope.stop();
/*log:
counter: 0
*/
```

åŸºæœ¬ä½¿ç”¨
æ–°å»ºä¸€ä¸ª scope:

```ts
const scope = effectScope();
```

ä¸€ä¸ª scope å¯ä»¥æ‰§è¡Œä¸€ä¸ª run å‡½æ•°ï¼ˆæ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›è¯¥å‡½æ•°çš„è¿”å›å€¼ï¼‰ï¼Œå¹¶ä¸”æ•è·æ‰€æœ‰åœ¨è¯¥å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºçš„ effect ï¼ŒåŒ…æ‹¬å¯ä»¥åˆ›å»º effect çš„ APIï¼Œä¾‹å¦‚ computed , watch , watchEffect :

```ts
scope.run(() => {
  const doubled = computed(() => counter.value * 2);

  watch(doubled, () => console.log(doubled.value));

  watchEffect(() => console.log("Count: ", doubled.value));
});

// the same scope can run multiple times
scope.run(() => {
  watch(counter, () => {
    /*...*/
  });
});
```

å½“è°ƒç”¨ scope.stop(), æ‰€æœ‰è¢«æ•è·çš„ effect éƒ½ä¼šè¢«å–æ¶ˆï¼ŒåŒ…æ‹¬ nested Scopes ä¹Ÿä¼šè¢«é€’å½’å–æ¶ˆ

## Nested Scopes

åµŒå¥— scope ä¹Ÿä¼šè¢«ä»–ä»¬çš„çˆ¶çº§ scope æ”¶é›†ã€‚å¹¶ä¸”å½“çˆ¶çº§ scope é”€æ¯çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„åä»£ scope ä¹Ÿä¼šè¢«é€’å½’é”€æ¯ã€‚

```ts
const scope = effectScope();

scope.run(() => {
  const doubled = computed(() => counter.value * 2);

  // not need to get the stop handler, it will be collected by the outer scope
  effectScope().run(() => {
    watch(doubled, () => console.log(doubled.value));
  });

  watchEffect(() => console.log("Count: ", doubled.value));
});

// dispose all effects, including those in the nested scopes
scope.stop();
```

## Detached Nested Scopes

effectScope æ¥å—ä¸€ä¸ªå‚æ•°å¯ä»¥åœ¨åˆ†ç¦»æ¨¡å¼ï¼ˆdetached modeï¼‰ä¸‹åˆ›å»ºã€‚ detached scope ä¸ä¼šè¢«çˆ¶çº§ collectã€‚

è¿™ä¸€ç‰¹æ€§åŒæ—¶è§£å†³äº†ä¸€ä¸ª Issues lazy Initializationã€‚

```ts
let nestedScope;

const parentScope = effectScope();

parentScope.run(() => {
  const doubled = computed(() => counter.value * 2);

  // with the detected flag,
  // the scope will not be collected and disposed by the outer scope
  nestedScope = effectScope(true /* detached */);
  nestedScope.run(() => {
    watch(doubled, () => console.log(doubled.value));
  });

  watchEffect(() => console.log("Count: ", doubled.value));
});

// disposes all effects, but not `nestedScope`
parentScope.stop();

// stop the nested scope only when appropriate
nestedScope.stop();
```

onScopeDispose
å…¨å±€é’©å­å‡½æ•° onScopeDispose æä¾›äº†ç±»ä¼¼äº onUnmounted çš„åŠŸèƒ½ï¼Œä¸åŒçš„æ˜¯å®ƒå·¥ä½œåœ¨ scope ä¸­è€Œä¸æ˜¯å½“å‰ instanceã€‚

è¿™ä½¿å¾— composable functions å¯ä»¥é€šè¿‡ä»–ä»¬çš„ scope æ¸…é™¤ä»–ä»¬çš„å‰¯ä½œç”¨ã€‚

ç”±äº setup() é»˜è®¤ä¼šä¸ºå½“å‰ instance åˆ›å»ºä¸€ä¸ª scopeï¼Œæ‰€ä»¥å½“æ²¡æœ‰æ˜ç¡®å£°æ˜ä¸€ä¸ª scope çš„æ—¶å€™ï¼ŒonScopeDispose ç­‰åŒäº onUnmountedã€‚

```ts
import { onScopeDispose } from "vue";

const scope = effectScope();

scope.run(() => {
  onScopeDispose(() => {
    console.log("cleaned!");
  });
});

scope.stop(); // logs 'cleaned!'
```

Getting the current Scope

é€šè¿‡ getCurrentScope() å¯ä»¥è·å–å½“å‰ scope

```ts
import { getCurrentScope } from "vue";

getCurrentScope(); // EffectScope | undefined
```

å®æˆ˜
ç¤ºä¾‹ï¼šShared Composable
ä¸€äº› composables ä¼šè®¾ç½®å…¨å±€å‰¯ä½œç”¨ï¼Œä¾‹å¦‚å¦‚ä¸‹çš„ useMouse() function:

```ts
function useMouse() {
  const x = ref(0);
  const y = ref(0);

  window.addEventListener("mousemove", handler);

  function handler(e) {
    x.value = e.x;
    y.value = e.y;
  }

  onUnmounted(() => {
    window.removeEventListener("mousemove", handler);
  });

  return { x, y };
}
```

å¦‚æœåœ¨å¤šä¸ªç»„ä»¶ä¸­è°ƒç”¨ useMouse () ï¼Œåˆ™æ¯ä¸ªç»„ä»¶å°†é™„åŠ ä¸€ä¸ª mouseemove ç›‘å¬å™¨ï¼Œå¹¶åˆ›å»ºè‡ªå·±çš„ x å’Œ y refs å‰¯æœ¬ã€‚æˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿé€šè¿‡åœ¨å¤šä¸ªç»„ä»¶ä¹‹é—´å…±äº«ç›¸åŒçš„ä¾¦å¬å™¨é›†å’Œ refs æ¥æé«˜æ•ˆç‡ï¼Œä½†æ˜¯æˆ‘ä»¬åšä¸åˆ°ï¼Œå› ä¸ºæ¯ä¸ª onUnmounted è°ƒç”¨éƒ½è€¦åˆåˆ°ä¸€ä¸ªç»„ä»¶å®ä¾‹ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ†ç¦»ä½œç”¨åŸŸå’Œ onScopeDispose æ¥å®ç°è¿™ä¸€ç‚¹, é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç”¨ onScopeDispose æ›¿æ¢ onUnmounted

```ts
- onUnmounted(() => {

* onScopeDispose(() => {
  window.removeEventListener('mousemove', handler)
  })
```

è¿™ä»ç„¶æœ‰æ•ˆï¼Œå› ä¸º Vue ç»„ä»¶ç°åœ¨ä¹Ÿåœ¨ä½œç”¨åŸŸå†…è¿è¡Œå…¶ setup () ï¼Œè¯¥ä½œç”¨åŸŸå°†åœ¨ç»„ä»¶å¸è½½æ—¶é‡Šæ”¾ã€‚

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå·¥å…·å‡½æ•°æ¥ç®¡ç†çˆ¶èŒƒå›´è®¢é˜…:

```ts
function createSharedComposable(composable) {
  let subscribers = 0;
  let state, scope;

  const dispose = () => {
    if (scope && --subscribers <= 0) {
      scope.stop();
      state = scope = null;
    }
  };
  // è¿™é‡Œåªæœ‰åœ¨ç¬¬ä¸€æ¬¡è¿è¡Œçš„æ—¶å€™åˆ›å»ºä¸€ä¸ª state, åé¢æ‰€æœ‰çš„ç»„ä»¶å°±ä¸ä¼šå†åˆ›å»ºæ–°çš„ stateï¼Œè€Œæ˜¯å…±ç”¨ä¸€ä¸ª state
  return (...args) => {
    subscribers++;
    if (!state) {
      scope = effectScope(true);
      state = scope.run(() => composable(...args));
    }
    onScopeDispose(dispose);
    return state;
  };
}
```

ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ª shared ç‰ˆæœ¬çš„ useMouse

```ts
const useSharedMouse = createSharedComposable(useMouse);
```

é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œä¸ç¦æƒ³åˆ°ï¼Œæ˜¯å¦å¯ä»¥é€šè¿‡è¿™ç§æ¨¡å¼æ¨¡æ‹Ÿ vuex çš„èƒ½åŠ›ï¼Ÿæˆ‘ä»¬æ˜¯å¦å¯ä»¥é€šè¿‡ shared composables æ›´åŠ çµæ´»çš„è¾¾åˆ°å…¨å±€çŠ¶æ€ç®¡ç†çš„ç›®çš„å‘¢ï¼Ÿ

ä½œè€…ï¼šzifeiyu
é“¾æ¥ï¼šhttps://juejin.cn/post/7019241635942760455

æ€»ç»“ï¼šè¯´äº†ä¸€å¤§å †ï¼Œå¤§æ¦‚æ„æ€æ˜¯æä¾›åœ¨ç»„ä»¶å¤–è¿›è¡Œå‰¯ä½œç”¨æ¸…ç†çš„ apiï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¯´ç»™åº“çš„å¼€å‘è€…ä½¿ç”¨

<hr/>

## stores ç›®å½•ï¼Œå¯¹åº” v2 çš„ vuex

ä¸€ä¸ªè´­ç‰©è½¦çš„ä¾‹å­

```ts
// .
// â”œâ”€â”€ cart.ts
// â”œâ”€â”€ counter.ts
// â”œâ”€â”€ counterSetup.ts
// â”œâ”€â”€ demo-counter.ts
// â”œâ”€â”€ jokes-swrv.ts
// â”œâ”€â”€ jokes.ts
// â”œâ”€â”€ jokesUsePromised.ts
// â”œâ”€â”€ nasa-pod.ts
// â”œâ”€â”€ nasa.ts
// â””â”€â”€ user.ts
```

**user.ts**

å®šä¹‰ useUserStoreï¼Œid ä¸ºâ€˜userâ€™, state ä¸¤ä¸ªå­—æ®µï¼Œ
actions 1. ç™»å½•ï¼Œè°ƒç”¨çš„æ˜¯ apiLogin æ¥å£ï¼Œè°ƒç”¨æˆåŠŸåè¿›è¡Œæ•°æ®`this.$patch`æ‰¹é‡æ›´æ–°
actions 2. é€€å‡ºç™»å½•

```ts
import { defineStore } from "pinia";

export const useUserStore = defineStore("user", {
  state: () => ({
    name: "Eduardo",
    isAdmin: true,
  }),
  actions: {
    /**
     * Attempt to login a user
     */
    async login(user: string, password: string) {
      const userData = await apiLogin(user, password);

      this.$patch({
        name: user,
        ...userData,
      });
    },
    logout() {
      this.$patch({
        name: "",
        isAdmin: false,
      });

      // we could do other stuff like redirecting the user
    },
  },
});

/**
 * Simulate a login æ¨¡æ‹Ÿç™»å½•
 */
function apiLogin(a: string, p: string) {
  if (a === "ed" && p === "ed") return Promise.resolve({ isAdmin: true }); // ç®¡ç†å‘˜
  if (p === "ed") return Promise.resolve({ isAdmin: false }); // éç®¡ç†å‘˜
  return Promise.reject(new Error("invalid credentials")); // æ¸¸å®¢æœªè®¤è¯
}
```

```ts
// counter.ts
import { acceptHMRUpdate, defineStore } from "pinia";

const delay = (t: number) => new Promise((r) => setTimeout(r, t));

export const useCounter = defineStore({
  id: "counter",

  state: () => ({
    n: 2,
    incrementedTimes: 0,
    decrementedTimes: 0,
    numbers: [] as number[],
  }),

  getters: {
    double: (state) => state.n * 2,
  },

  actions: {
    increment(amount = 1) {
      if (typeof amount !== "number") {
        amount = 1;
      }
      this.incrementedTimes++;
      this.n += amount;
    },

    changeMe() {
      console.log("change me to test HMR");
    },

    async fail() {
      const n = this.n;
      await delay(1000);
      this.numbers.push(n);
      await delay(1000);
      if (this.n !== n) {
        throw new Error("Someone changed n!");
      }

      return n;
    },

    async decrementToZero(interval: number = 300, usePatch = true) {
      if (this.n <= 0) return;

      while (this.n > 0) {
        if (usePatch) {
          this.$patch({
            // è¿™ä¸ªå°±æ¯”è¾ƒå¥‡æ€ªäº†ï¼Œæˆ‘ä¸¥é‡æ€€ç–‘è¿™é‡Œçš„(usePatch = true ä¸ usePatch = false)æ•°æ®ä¸ä¸€è‡´
            n: this.n - 1,
            decrementedTimes: this.decrementedTimes + 1,
          });
          // this.$patch(state => {
          //   state.n--
          //   state.decrementedTimes++
          // })
        } else {
          this.n -= 1;
        }
        await delay(interval);
      }
    },
  },
});

// è¿™ä¸ªåœ°æ–¹æ²¡çœ‹æ‡‚.

if (import.meta.hot) {
  // @link: https://www.jb51.net/article/244749.htm
  // import.meta æ˜¯ä¸€ä¸ªç»™ JavaScript æ¨¡å—æš´éœ²ç‰¹å®šä¸Šä¸‹æ–‡çš„å…ƒæ•°æ®å±æ€§çš„å¯¹è±¡ï¼Œå®ƒåŒ…å«äº†è¿™ä¸ªæ¨¡å—çš„ä¿¡æ¯ã€‚
  // Pinia æ˜¯ vuex æ–°æ›¿ä»£æ–¹æ¡ˆã€‚Pinia ä¸­çƒ­æ›´æ–°å®ç°ï¼Œå€ŸåŠ© import.metaã€‚
  import.meta.hot.accept(acceptHMRUpdate(useCounter, import.meta.hot));
}
```

counterSetup.ts ç»“åˆ vue åšäº†å¾ˆå¤šæ“ä½œï¼Œæœ€ååªè¿”å›äº†ä¸€ä¸ª state,æ²¡æœ‰ getters,actions
ä»¥ä¸‹ä¸º state ä¸Šçš„æ–¹æ³•

- double,
- increment,
- fail,
- changeMe,
- decrementToZero,

```ts
// counterSetup
import { computed, toRefs, reactive } from "vue";
import { acceptHMRUpdate, defineStore } from "pinia";

const delay = (t: number) => new Promise((r) => setTimeout(r, t));

export const useCounter = defineStore("counter-setup", () => {
  const state = reactive({
    // vue
    n: 0,
    incrementedTimes: 0,
    decrementedTimes: 0,
    numbers: [] as number[],
  });

  const double = computed(() => state.n * 2); // vue

  function increment(amount = 1) {
    if (typeof amount !== "number") {
      amount = 1;
    }
    state.incrementedTimes++;
    state.n += amount;
  }

  function changeMe() {
    console.log("change me to test HMR");
  }
  //
  async function fail() {
    const n = state.n;
    await delay(1000);
    state.numbers.push(n);
    await delay(1000);
    if (state.n !== n) {
      throw new Error("Someone changed n!");
    }

    return n;
  }
  // å®šæ—¶å™¨ç›´åˆ°å‡å°‘åˆ°0
  async function decrementToZero(interval: number = 300) {
    if (state.n <= 0) return;

    while (state.n > 0) {
      state.n -= 1;
      state.decrementedTimes += 1;
      await delay(interval);
    }
  }

  return {
    ...toRefs(state), // vueå°† state è½¬æ¢ä¸º refsï¼Œ TODOï¼štoRefsè¿™ä¸ªä¹‹åå¯ä»¥çœ‹ä¸‹æºç åšäº†æ€æ ·çš„å¤„ç†
    double,
    increment,
    fail,
    changeMe,
    decrementToZero,
  };
});

if (import.meta.hot) {
  import.meta.hot.accept(acceptHMRUpdate(useCounter, import.meta.hot));
}
```
demo-counter.ts åªè¿”å›ä¸€ä¸ªç®­å¤´å‡½æ•°ç®€å†™çš„state
```ts
// demo-counter.ts
import { defineStore, acceptHMRUpdate } from 'pinia'

const delay = (t: number) => new Promise((r) => setTimeout(r, t))
// just to ignore the not used error
delay(0)

export const useCounter = defineStore('demo-counter', {
  state: () => ({
    n: 0,
  }),
})

if (import.meta.hot) {
  import.meta.hot.accept(acceptHMRUpdate(useCounter, import.meta.hot))
}

```

```ts
// jokes-swrv.ts

import { ref, toRaw, watch } from 'vue'
import { acceptHMRUpdate, defineStore } from 'pinia'
import { getRandomJoke, Joke } from '../api/jokes'
import useSWRV from 'swrv' // @link https://www.npmjs.com/package/swrv

export const useJokesSetup = defineStore('jokes-swrv-setup', () => {
  // const current = ref<null | Joke>(null)
  const history = ref<Joke[]>([])
  // useSWRV vueç»„åˆå¼ç½‘ç»œè¯·æ±‚ï¼Œä¹‹å‰äº†è§£ä»£ç `pinia/packages/playground/src/api` ä¸­ä½¿ç”¨äº†â€˜mandeâ€™ï¼Œåšç½‘ç»œè¯·æ±‚ï¼Œæˆ‘æƒ³è¿™åº”è¯¥æ˜¯ä½œè€…ä¸ºäº†ç»™å¼€å‘è€…æä¾›æ›´å¤šçš„åœºæ™¯æ¥å­¦ä¹ pinia
  const { data, error, mutate } = useSWRV('jokes', getRandomJoke)
  // ç›‘å¬dataå˜åŒ–
  watch(data, (joke) => {
    console.log('changed from within the store', joke)
    if (joke) {
      // å“åº”å¼æ•°æ®ï¼Œ  historyæ˜¯å“åº”å¼çš„ï¼Œéœ€è¦ç”¨.valueæ¥æ“ä½œ
      history.value.push(toRaw(joke))
    }
  })

  return { current: data, error, history, fetchJoke: mutate }
})

if (import.meta.hot) {
  // import.meta.hot.accept(acceptHMRUpdate(useJokes, import.meta.hot))
  import.meta.hot.accept(acceptHMRUpdate(useJokesSetup, import.meta.hot))
}


```
 jokes.ts æ–‡ä»¶ä¸‹ï¼Œå†™äº†useJokes å’Œ useJokesSetup
```ts
// jokes.ts
import { ref, unref } from 'vue'
import { acceptHMRUpdate, defineStore } from 'pinia'
import { getRandomJoke, Joke } from '../api/jokes'

export const useJokes = defineStore('jokes', {
  state: () => ({
    current: null as null | Joke,
    jokes: [] as Joke[],
    // hello: true,
  }),
  actions: {
    async fetchJoke() {
      if (
        this.current &&
        // if the request below fails, avoid adding it twice
        // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œå°±ä¸è¦æ·»åŠ è¿›å†å²è®°å½•
        !this.jokes.includes(this.current)
      ) {
        this.jokes.push(this.current)
      }

      // NOTE: Avoid patching an object because it's recursive
      // æ³¨æ„ï¼šä¸è¦æ›´æ–°ä¸€ä¸ªå¯¹è±¡ï¼Œå› ä¸ºå®ƒæ˜¯é€’å½’çš„
      // this.$patch({ current: await getRandomJoke() })
      this.current = await getRandomJoke()
    },
  },
})

export const useJokesSetup = defineStore('jokes-setup', () => {
  const current = ref<null | Joke>(null)
  const history = ref<Joke[]>([])

  async function fetchJoke() {
    const cur = unref(current.value)
    if (
      cur &&
      // if the request below fails, avoid adding it twice
      !history.value.find((joke) => joke.id === cur.id)
    ) {
      history.value.push(cur)
    }

    current.value = await getRandomJoke()
    return current.value
  }

  return { current, history, fetchJoke }
})

if (import.meta.hot) {
  import.meta.hot.accept(acceptHMRUpdate(useJokes, import.meta.hot))
  // import.meta.hot.accept(acceptHMRUpdate(useJokesSetup, import.meta.hot))
}

```