---
title: axios 1.0.0-alpha.1 æºç 
date: 2022-06-23 09:22:54
categories: vue
tags: [æºç ]
cover: http://t-blog-images.aijs.top/img/20220623092515.webp
---

## å®˜ç½‘

<a href="https://axios-http.com" target="_blank" >å®˜ç½‘é¦–é¡µ</a>
<a href="https://axios-http.com/docs/intro" target="_blank" >å®˜æ–¹æ–‡æ¡£ä»‹ç»</a>
<a href="https://axios-http.com/zh/docs/example" target="_blank" >ä¸­æ–‡æ–‡æ¡£</a>

Promise based HTTP client for the browser and node.js
_åŸºäº promise å¯ä»¥ç”¨äºæµè§ˆå™¨å’Œ node.js çš„ç½‘ç»œè¯·æ±‚åº“_

Axios is a promise-based HTTP Client for node.js and the browser. It is isomorphic (= it can run in the browser and nodejs with the same codebase). On the server-side it uses the native node.js http module, while on the client (browser) it uses XMLHttpRequests.
_Axios æ˜¯ä¸€ä¸ªåŸºäº promise ç½‘ç»œè¯·æ±‚åº“ï¼Œä½œç”¨äº node.js å’Œæµè§ˆå™¨ä¸­ã€‚ å®ƒæ˜¯ isomorphicã€ŒåŒæ„ã€ çš„(å³åŒä¸€å¥—ä»£ç å¯ä»¥è¿è¡Œåœ¨æµè§ˆå™¨å’Œ node.js ä¸­)ã€‚åœ¨æœåŠ¡ç«¯å®ƒä½¿ç”¨åŸç”Ÿ node.js http æ¨¡å—, è€Œåœ¨å®¢æˆ·ç«¯ (æµè§ˆç«¯) åˆ™ä½¿ç”¨ XMLHttpRequestsã€‚_

## ç‰¹æ€§

- ä»æµè§ˆå™¨åˆ›å»º XMLHttpRequests
- ä» node.js åˆ›å»º http è¯·æ±‚
- æ”¯æŒ Promise API
- æ‹¦æˆªè¯·æ±‚å’Œå“åº”
- è½¬æ¢è¯·æ±‚å’Œå“åº”æ•°æ®
- å–æ¶ˆè¯·æ±‚
- è‡ªåŠ¨è½¬æ¢ JSON æ•°æ®
- å®¢æˆ·ç«¯æ”¯æŒé˜²å¾¡ XSRF

## ä½¿ç”¨åŠ Axios API

<a href="https://axios-http.com/zh/docs/example" target="_blank" >get example ä½¿ç”¨</a>
<a href="https://axios-http.com/zh/docs/post_example" target="_blank" >post example ä½¿ç”¨</a>
<a href="https://axios-http.com/zh/docs/api_intro" target="_blank" >API</a>

:::tip
è¯·æ±‚æ–¹å¼åˆ«å
ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œå·²ç»ä¸ºæ‰€æœ‰æ”¯æŒçš„è¯·æ±‚æ–¹æ³•æä¾›äº†åˆ«åã€‚

axios.request(config)
axios.get(url[, config])
axios.delete(url[, config])
axios.head(url[, config]) ?
axios.options(url[, config]) é¢„æ£€
axios.post(url[, data[, config]])
axios.put(url[, data[, config]])
axios.patch(url[, data[, config]])? patch æ–¹æ³•ç”¨æ¥æ›´æ–°å±€éƒ¨èµ„æº
æ³¨æ„
åœ¨ä½¿ç”¨åˆ«åæ–¹æ³•æ—¶ï¼Œ urlã€methodã€data è¿™äº›å±æ€§éƒ½ä¸å¿…åœ¨é…ç½®ä¸­æŒ‡å®šã€‚

restful åªæ˜¯æ ‡å‡†ï¼Œæ ‡å‡†çš„æ„æ€æ˜¯å¦‚æœåœ¨å¤§å®¶éƒ½ä¾æ­¤è¡Œäº‹çš„è¯ï¼Œæ²Ÿé€šæˆæœ¬ä¼šå¾ˆä½ï¼Œå¼€å‘æ•ˆç‡å°±é«˜ã€‚ä½†å¹¶éå¼ºåˆ¶(ä¹Ÿæ²¡äººå¼ºåˆ¶å¾—äº†)ï¼Œæ‰€ä»¥ä½ è¯´åœ¨ä½ çš„ç¨‹åºé‡ŒæŠŠæ–¹æ³•åä» put æ”¹æˆ patch æ²¡æœ‰ä»»ä½•å½±å“ï¼Œé‚£æ˜¯è‡ªç„¶ï¼Œå› ä¸ºä½ çš„åç«¯ç¨‹åºå¹¶æ²¡æœ‰æŒ‰ç…§æ ‡å‡†å¯¹ä¸¤ä¸ªæ–¹æ³•åšä¸åŒå¤„ç†ï¼Œå¥¹çš„è¡¨ç°è‡ªç„¶æ˜¯ä¸€æ ·çš„

å³çº¦å®šï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„äººéƒ½è¿™ä¹ˆå¹²ï¼Œå…·ä½“é¡¹ç›®å¦‚ä½•å®ç°ï¼Œè¿˜éœ€è¦å‰åç«¯ä¸€è‡´ï¼ˆæ‰“ä¸ªæ¯”æ–¹ï¼šæœ‰çš„åç«¯ç”¨ post åšåˆ é™¤ï¼Œç”¨ post åšæŸ¥è¯¢ï¼Œç”¨ post åšæ›´æ–°ï¼Œå†ä¸¾ä¸ªä¾‹å­ä¸‰è„šæ’å¤´æœ‰å¤§æœ‰å°ä¸çŸ¥é“ä½ æ™“ä¸æ™“å¾—ï¼Ÿåªè¦å¯¹åº”çš„æ’å­”æ˜¯å¯¹åº”çš„å¤§å°ä¹Ÿå°±å¯ä»¥è¿è¡Œï¼Œè¦ä¸ç„¶è¿ä¸ä¸Šï¼‰

:::

...

**axios.options(url[, config])**

[axios ä¸­ä¸ºä»€ä¹ˆä¼šæœ‰ OPTIONS è¯·æ±‚](https://blog.csdn.net/csdnyp/article/details/122651869)

> æµè§ˆå™¨é™åˆ¶è·¨åŸŸ
> æµè§ˆå™¨é™åˆ¶è·¨åŸŸè¯·æ±‚ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼š
> 1ã€é™åˆ¶å‘èµ·è·¨åŸŸè¯·æ±‚
> 2ã€è·¨åŸŸè¯·æ±‚å¯ä»¥æ­£å¸¸å‘èµ·ï¼Œä½†æ˜¯è¿”å›çš„ç»“æœä¼šè¢«æµè§ˆå™¨æ‹¦æˆª

> ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨ä¼šä»¥ç¬¬äºŒç§æ–¹å¼é™åˆ¶è·¨åŸŸè¯·æ±‚ã€‚è¿™ç§å­˜åœ¨ä¸€ç§æƒ…å†µï¼Œ_è¯·æ±‚å·²ç»åˆ°è¾¾æœåŠ¡å™¨å¹¶å“åº”äº†æŸäº›æ“ä½œï¼Œæ”¹å˜äº†æ•°æ®åº“æ•°æ®ï¼Œä½†æ˜¯è¿”å›çš„ç»“æœä¼šè¢«æµè§ˆå™¨æ‹¦æˆªï¼Œç”¨æˆ·å°±ä¸èƒ½å–åˆ°ç›¸åº”çš„ç»“æœè¿›è¡Œåç»­çš„æ“ä½œ_ã€‚**æ‰€ä»¥ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæµè§ˆå™¨å°±ä¼šé€šè¿‡ OPTIONS æ–¹æ³•å¯¹è¯·æ±‚è¿›è¡Œé¢„æ£€ï¼Œé€šè¿‡è¯¢é—®æœåŠ¡å™¨æ˜¯å¦å…è®¸è¿™æ¬¡è¯·æ±‚ï¼Œå…è®¸ä¹‹åï¼ŒæœåŠ¡å™¨æ‰ä¼šå“åº”çœŸå®è¯·æ±‚ï¼Œå¦åˆ™å°±é˜»æ­¢çœŸå®è¯·æ±‚**ã€‚

> é¡¹ç›®ä¸­éœ€è¦ OPTIONS é¢„æ£€å—ï¼Ÿ
> ç”¨æˆ·ç™»é™†ä¹‹åï¼Œæˆ‘ä»¬ä¼šè·å– token å€¼ï¼Œåœ¨æ¯ä¸€æ¬¡å‘èµ·è¯·æ±‚æ—¶ï¼Œè¯·æ±‚å¤´éƒ½ä¼šæºå¸¦è¿™ä¸ª token å€¼ï¼Œæ‰€ä»¥ä¼šè§¦å‘é¢„æ£€è¯·æ±‚ã€‚å› ä¸ºç›®å‰é™¤äº†ç™»å½•ï¼Œå…¶ä»–è¯·æ±‚æ¥å£è¯·æ±‚å¤´éƒ½æºå¸¦äº† tokenï¼Œè€Œä¸”æˆ‘ä»¬çš„ Content-Type ç»å¤§å¤šæ•°æ˜¯ application/jsonï¼Œæ‰€ä»¥é¢„æ£€æ€»ä¼šå­˜åœ¨ã€‚å¦‚æœä¸æƒ³å‘èµ· OPTIONS é¢„æ£€è¯·æ±‚ï¼Œå»ºè®®åç«¯åœ¨è¯·æ±‚çš„è¿”å›å¤´éƒ¨æ·»åŠ ï¼šAccess-Control-Max-Age:(number)ã€‚

<a href="https://blog.csdn.net/u011200562/article/details/110431341" target="_blank" >Access-Control-Max-Age æ˜¯ä»€ä¹ˆ</a>

> æµè§ˆå™¨çš„åŒæºç­–ç•¥ï¼Œå°±æ˜¯å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œæµè§ˆå™¨ä¼šé™åˆ¶ä»è„šæœ¬å‘èµ·çš„è·¨åŸŸ HTTP è¯·æ±‚ï¼ˆæ¯”å¦‚å¼‚æ­¥è¯·æ±‚ GET, POST, PUT, DELETE, OPTIONS ç­‰ç­‰ï¼‰ï¼Œæ‰€ä»¥æµè§ˆå™¨ä¼šå‘æ‰€è¯·æ±‚çš„æœåŠ¡å™¨å‘èµ·ä¸¤æ¬¡è¯·æ±‚ï¼Œç¬¬ä¸€æ¬¡æ˜¯æµè§ˆå™¨ä½¿ç”¨ OPTIONS æ–¹æ³•å‘èµ·ä¸€ä¸ªé¢„æ£€è¯·æ±‚ï¼Œç¬¬äºŒæ¬¡æ‰æ˜¯çœŸæ­£çš„å¼‚æ­¥è¯·æ±‚ï¼Œç¬¬ä¸€æ¬¡çš„é¢„æ£€è¯·æ±‚è·çŸ¥æœåŠ¡å™¨æ˜¯å¦å…è®¸è¯¥è·¨åŸŸè¯·æ±‚ï¼šå¦‚æœå…è®¸ï¼Œæ‰å‘èµ·ç¬¬äºŒæ¬¡çœŸå®çš„è¯·æ±‚ï¼›å¦‚æœä¸å…è®¸ï¼Œåˆ™æ‹¦æˆªç¬¬äºŒæ¬¡è¯·æ±‚ã€‚
>
> Access-Control-Max-Age ç”¨æ¥æŒ‡å®šæœ¬æ¬¡é¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’ï¼Œï¼Œåœ¨æ­¤æœŸé—´ä¸ç”¨å‘å‡ºå¦ä¸€æ¡é¢„æ£€è¯·æ±‚ã€‚
>
> ä¾‹å¦‚ï¼š
>
> resp.addHeader("Access-Control-Max-Age", "0")ï¼Œè¡¨ç¤ºæ¯æ¬¡å¼‚æ­¥è¯·æ±‚éƒ½å‘èµ·é¢„æ£€è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€ä¸¤æ¬¡è¯·æ±‚ã€‚
>
> resp.addHeader("Access-Control-Max-Age", "1800")ï¼Œè¡¨ç¤ºéš” 30 åˆ†é’Ÿæ‰å‘èµ·é¢„æ£€è¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€ä¸¤æ¬¡è¯·æ±‚

## æ³¨æ„ç‚¹

1. <a href="https://axios-http.com/zh/docs/config_defaults#:~:text=%3D%20AUTH_TOKEN%3B-,%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7,-%E9%85%8D%E7%BD%AE%E5%B0%86%E4%BC%9A%E6%8C%89" target="_blank" >é…ç½®çš„ä¼˜å…ˆçº§</a>
   é…ç½®å°†ä¼šæŒ‰ä¼˜å…ˆçº§è¿›è¡Œåˆå¹¶ã€‚å®ƒçš„é¡ºåºæ˜¯ï¼šåœ¨ `lib/defaults.js` ä¸­æ‰¾åˆ°çš„åº“é»˜è®¤å€¼ï¼Œç„¶åæ˜¯å®ä¾‹çš„ `defaults` å±æ€§ï¼Œæœ€åæ˜¯`è¯·æ±‚çš„ config å‚æ•°`ã€‚åé¢çš„ä¼˜å…ˆçº§è¦é«˜äºå‰é¢çš„ã€‚ä¸‹é¢æœ‰ä¸€ä¸ªä¾‹å­ã€‚

   ```js
   // ä½¿ç”¨åº“æä¾›çš„é»˜è®¤é…ç½®åˆ›å»ºå®ä¾‹
   // æ­¤æ—¶è¶…æ—¶é…ç½®çš„é»˜è®¤å€¼æ˜¯ `0`
   const instance = axios.create();
   // é‡å†™åº“çš„è¶…æ—¶é»˜è®¤å€¼
   // ç°åœ¨ï¼Œæ‰€æœ‰ä½¿ç”¨æ­¤å®ä¾‹çš„è¯·æ±‚éƒ½å°†ç­‰å¾… 2.5 ç§’ï¼Œç„¶åæ‰ä¼šè¶…æ—¶
   instance.defaults.timeout = 2500;

   // é‡å†™æ­¤è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œå› ä¸ºè¯¥è¯·æ±‚éœ€è¦å¾ˆé•¿æ—¶é—´
   instance.get("/longRequest", {
     timeout: 5000,
   });
   ```

2. ç‰ˆæœ¬å‘å¸ƒæ²¡æœ‰éµå®ˆ`è¯­ä¹‰åŒ–ç‰ˆæœ¬`

åœ¨ redux ç« èŠ‚æ›¾èŠè¿‡åŒ…çš„ç‰ˆæœ¬, å¿…é¡»æœ‰, è¦ç¬¦åˆ[semantic versioning guidelines](https://docs.npmjs.com/about-semantic-versioning), å‚è€ƒ [è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶è§„èŒƒ](https://semver.org/lang/zh-CN/), å»ºè®®ä»”ç»†é€šè¯»
<img src="http://t-blog-images.aijs.top/img/20220525140247.webp" width=600 style="object-fit: content"/>

<p></p>

## å‡è®¾

å·²ç»é€šè¿‡å®˜æ–¹æ–‡æ¡£å¯¹ axios çš„ä½¿ç”¨å’Œ api å·²ç»æœ‰äº†åˆæ­¥çš„äº†è§£

## æºç 

- äº†è§£ç‰¹æ€§çš„å®ç°è¿‡ç¨‹
- äº†è§£ api çš„å®ç°è¿‡ç¨‹
- çœ‹çœ‹ä»£ç é ä¸é è°±ï¼Œæœ‰æ²¡æœ‰â€œå½©è›‹â€(è›™å»ï½ï¼Œæˆ‘æ—©ä¸Šçªç„¶å†’çš„æƒ³æ³•ï¼Œç«Ÿç„¶åœ¨ä¸‹åˆçœŸçš„é‡åˆ°äº†ï¼Œç›´è§‰ï½)

```shell
.
â”œâ”€â”€ CHANGELOG.md
â”œâ”€â”€ CODE_OF_CONDUCT.md
â”œâ”€â”€ COLLABORATOR_GUIDE.md
â”œâ”€â”€ CONTRIBUTING.md
â”œâ”€â”€ ECOSYSTEM.md
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ SECURITY.md
â”œâ”€â”€ UPGRADE_GUIDE.md
â”œâ”€â”€ bin
â”œâ”€â”€ bower.json # ç”¨äºbower install
â”œâ”€â”€ dist
â”œâ”€â”€ examples
â”œâ”€â”€ gulpfile.js # gulpä»»åŠ¡
â”œâ”€â”€ index.d.ts
â”œâ”€â”€ index.js
â”œâ”€â”€ karma.conf.cjs
â”œâ”€â”€ lib
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json # "build": "gulp clear && cross-env NODE_ENV=production rollup -c -m",
â”œâ”€â”€ rollup.config.js # rollup æ‰“åŒ…é…ç½®
â”œâ”€â”€ sandbox # ä¸€ä¸ªå‰åç«¯æµ‹è¯•demo
â”œâ”€â”€ test
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tslint.json
â””â”€â”€ webpack.config.js # webpacké…ç½®ï¼Œæ²¡æœ‰ä½¿ç”¨çš„æ ·å­

6 directories, 20 files

```

## gulpfile.js

gulpfile ç°åœ¨é¡¹ç›®å¾ˆå°‘è§ï¼Œä¸Šæ¬¡è§æ˜¯åœ¨ 2017 å¹´çš„æ—¶å€™äº†ï¼Œä¸€å¼€å§‹ï¼Œæˆ‘çœ‹åˆ°æœ‰ æ ¹ç›®å½•`bower.json` `gulpfile.js` `rollup.config.js` `webpack.config.js`,æœ‰ç‚¹æ‡µé€¼ï½

<img src="http://t-blog-images.aijs.top/img/20220623135204.webp"/>

## bower.json

**äº†è§£ä¸‹ï¼Œæœ‰è¿™ä¹ˆä¸ªä¸œè¥¿ï¼Œä»¥åä¼°è®¡ä¹Ÿç”¨ä¸åˆ°**

<a href="https://baijiahao.baidu.com/s?id=1710656712337561707&wfr=spider&for=pc" target="_blank" >bower ä»‹ç»è§</a>
<a href="https://github.com/bower/bower" target="_blank" >github ä»“åº“</a>

Bower æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„è½¯ä»¶åŒ…ç®¡ç†å™¨ï¼Œå®ƒå¯ç”¨äºæœç´¢ã€å®‰è£…å’Œå¸è½½å¦‚ JavaScriptã€HTMLã€CSS
ä¹‹ç±»çš„ç½‘ç»œèµ„æºï¼ŒBower æ˜¯ Web å¼€å‘ä¸­çš„ä¸€ä¸ªå‰ç«¯æ–‡ä»¶åŒ…ç®¡ç†å™¨ï¼Œç±»ä¼¼äº Node æ¨¡å—çš„
npm åŒ…ç®¡ç†å™¨ï¼Œbower ä¾èµ–äº Gitã€Node å’Œ npmã€‚

## package.json

çœ‹å®Œä¸Šè¿°å‡ ä¸ªæ–‡ä»¶æœ‰ç‚¹æ‡µï¼Œå·¥å…·åƒæ˜¯é‡å¤çš„æ ·å­

```json
  "scripts": {
    "test": "npm run test:eslint && npm run test:mocha && npm run test:karma && npm run test:dtslint",
    "test:eslint": "node bin/ssl_hotfix.js eslint lib/**/*.js",
    "test:dtslint": "node bin/ssl_hotfix.js dtslint",
    "test:mocha": "node bin/ssl_hotfix.js mocha test/unit/**/*.js --timeout 30000 --exit",
    "test:karma": "node bin/ssl_hotfix.js cross-env LISTEN_ADDR=:: karma start karma.conf.cjs --single-run",
    "test:karma:server": "node bin/ssl_hotfix.js cross-env karma start karma.conf.cjs",
    "start": "node ./sandbox/server.js",
    "preversion": "gulp version && npm test",
    "version": "npm run build && git add dist && git add package.json",
    "prepublishOnly": "npm test",
    "postpublish": "git push && git push --tags ",
    "build": "gulp clear && cross-env NODE_ENV=production rollup -c -m", // æ‰“åŒ…åªç”¨åˆ°äº†gulp å’Œ rollupï¼Œæ²¡æœ‰ç”¨åˆ°webpack,webpack.config.jsæ˜¯å¤šä½™çš„
    "examples": "node ./examples/server.js",
    "coveralls": "cat coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js",
    "fix": "eslint --fix lib/**/*.js"
  },
```

## rollup.config.js

```js
import resolve from "@rollup/plugin-node-resolve";
import commonjs from "@rollup/plugin-commonjs";
import { terser } from "rollup-plugin-terser";
import json from "@rollup/plugin-json";
import { babel } from "@rollup/plugin-babel";
import autoExternal from "rollup-plugin-auto-external";

const lib = require("./package.json");
const outputFileName = "axios";
const name = "axios";
const input = "./lib/axios.js"; // æºç å…¥å£
// minifiedVersionå‚æ•°æœ€å°åŒ–ï¼Œé»˜è®¤trueï¼Œä¸‹é¢ä¸‰å¤„è°ƒç”¨éƒ½æ²¡æœ‰ä¼ ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸webpack.config.jsæ— å…³
const buildConfig = ({
  es5,
  browser = true,
  minifiedVersion = true,
  ...config
}) => {
  const build = ({ minified }) => ({
    input,
    ...config,
    output: {
      ...config.output, // é‡Œé¢æœ‰bannerä¿¡æ¯
      file: `${config.output.file}.${minified ? "min.js" : "js"}`,
    },
    plugins: [
      json(),
      resolve({ browser }),
      commonjs(),
      minified && terser(),
      ...(es5
        ? [
            babel({
              babelHelpers: "bundled",
              presets: ["@babel/preset-env"],
            }),
          ]
        : []),
      ...(config.plugins || []),
    ],
  });

  const configs = [build({ minified: false })];

  if (minifiedVersion) {
    build({ minified: true });
  }

  return configs;
};

export default async () => {
  const year = new Date().getFullYear();
  const banner = `// Axios v${lib.version} Copyright (c) ${year} ${lib.author} and contributors`;

  return [
    ...buildConfig({
      es5: true,
      output: {
        file: `dist/${outputFileName}`,
        name,
        format: "umd", // umdæ ¼å¼
        exports: "default",
        banner,
      },
    }),

    ...buildConfig({
      output: {
        file: `dist/esm/${outputFileName}`,
        format: "esm", // esmæ ¼å¼
        preferConst: true,
        exports: "named",
        banner,
      },
    }),
    // Node.js commonjs build
    {
      input,
      output: {
        file: `dist/node/${name}.cjs`,
        format: "cjs", // commonjsæ ¼å¼
        preferConst: true,
        exports: "default",
        banner,
      },
      plugins: [autoExternal(), resolve(), commonjs()],
    },
  ];
};
```

## æ³¨æ„

:::warning

```shell
ğŸ‘‘ ~/Desktop/axios git:(v1.x) âœ— $ yarn build
yarn run v1.4.0
$ gulp clear && cross-env NODE_ENV=production rollup -c -m
[14:19:33] Using gulpfile ~/Desktop/axios/gulpfile.js
[14:19:33] Starting 'clear'...
[14:19:33] Finished 'clear' after 5.74 ms
[!] Error: Cannot find module '@babel/core'
Require stack:
- /Users/haotian/Desktop/axios/node_modules/@rollup/plugin-babel/dist/index.js
- /Users/haotian/Desktop/axios/rollup.config.js
- /Users/haotian/Desktop/axios/node_modules/rollup/dist/shared/loadConfigFile.js
- /Users/haotian/Desktop/axios/node_modules/rollup/dist/bin/rollup
Error: Cannot find module '@babel/core'

è§£å†³ï¼š

ğŸ‘‘ ~/Desktop/axios git:(v1.x) âœ— $ yarn add @babel/core -D
yarn add v1.4.0
[1/4] ğŸ”  Resolving packages...
[2/4] ğŸšš  Fetching packages...
warning Pattern ["@definitelytyped/typescript-versions@latest"] is trying to unpack in the same destination "/Users/haotian/Library/Caches/Yarn/v1/npm-@definitelytyped/typescript-versions-0.0.118-de13fb755c5181443860c3c74b6730f47f6541fc" as pattern ["@definitelytyped/typescript-versions@^0.0.118","@definitelytyped/typescript-versions@^0.0.118","@definitelytyped/typescript-versions@^0.0.118"]. This could result in non-deterministic behavior, skipping.
[3/4] ğŸ”—  Linking dependencies...
warning " > @rollup/plugin-babel@5.3.1" has unmet peer dependency "@types/babel__core@^7.1.9".
warning " > istanbul-instrumenter-loader@3.0.1" has unmet peer dependency "webpack@^2.0.0 || ^3.0.0 || ^4.0.0".
warning "karma > socket.io > engine.io > ws@8.2.3" has unmet peer dependency "bufferutil@^4.0.1".
warning "karma > socket.io > engine.io > ws@8.2.3" has unmet peer dependency "utf-8-validate@^5.0.2".
warning "karma-sauce-launcher > webdriverio > puppeteer-core > node-fetch@2.6.7" has unmet peer dependency "encoding@^0.1.0".
warning "karma-sauce-launcher > webdriverio > puppeteer-core > ws@7.5.8" has unmet peer dependency "bufferutil@^4.0.1".
warning "karma-sauce-launcher > webdriverio > puppeteer-core > ws@7.5.8" has unmet peer dependency "utf-8-validate@^5.0.2".
warning " > terser-webpack-plugin@4.2.3" has unmet peer dependency "webpack@^4.0.0 || ^5.0.0".
[4/4] ğŸ“ƒ  Building fresh packages...
success Saved lockfile.
success Saved 5 new dependencies.
â”œâ”€ @ampproject/remapping@2.2.0
â”œâ”€ @babel/core@7.18.5
â”œâ”€ @babel/helpers@7.18.2
â”œâ”€ gensync@1.0.0-beta.2
â””â”€ json5@2.2.1
âœ¨  Done in 37.80s.
ğŸ‘‘ ~/Desktop/axios git:(v1.x) âœ— $ yarn build
yarn run v1.4.0
$ gulp clear && cross-env NODE_ENV=production rollup -c -m
[14:20:32] Using gulpfile ~/Desktop/axios/gulpfile.js
[14:20:32] Starting 'clear'...
[14:20:32] Finished 'clear' after 48 ms

./lib/axios.js â†’ dist/axios.js...
created dist/axios.js in 3.5s

./lib/axios.js â†’ dist/esm/axios.js...
created dist/esm/axios.js in 711ms

./lib/axios.js â†’ dist/node/axios.cjs...
created dist/node/axios.cjs in 1.1s
âœ¨  Done in 9.39s.
ğŸ‘‘ ~/Desktop/axios git:(v1.x) âœ— $
```

:::

## æ‰“åŒ…äº§ç‰©

```shell
.
â”œâ”€â”€ axios.js
â”œâ”€â”€ axios.js.map
â”œâ”€â”€ esm
â”‚   â”œâ”€â”€ axios.js
â”‚   â””â”€â”€ axios.js.map
â””â”€â”€ node
    â”œâ”€â”€ axios.cjs
    â””â”€â”€ axios.cjs.map

2 directories, 6 files
```

å“ï¼Ÿå’‹æ»´å›äº‹ï¼Œæˆ‘ä»¬åœ¨`rollup.config.js`è§åˆ°`minifiedVersion`é»˜è®¤æ˜¯`true`,ä¼ ç»™ `minified`å’‹çš„æ²¡è§`min.js`

```js
const configs = [build({ minified: false })];

if (minifiedVersion) {
  build({ minified: true }); // è¿™ä¹ˆäº›åº”è¯¥æ˜¯ä¸ºäº†å¼€å‘è°ƒè¯•ï¼Œåœ¨sandboxä¸­ <script src="/axios.js"></script>
}

return configs;
// è¿™é‡Œæš´éœ²çš„æ˜¯configsï¼Œ build({minified: true})å®Œå…¨æ²¡æäº‹æƒ…ï¼Œ
// è¿™ä»£ç åº”è¯¥æ˜¯ç”¨ build({minified: true}) æ›¿æ¢   build({minified: false}) æ‰å¯¹
```

ä¿®æ”¹ä¸‹ï¼Œç„¶åè¿è¡Œ`yarn build`

<img src="http://t-blog-images.aijs.top/img/20220623143251.webp" />

## axios.js

```js
"use strict";

import utils from "./utils.js";
import bind from "./helpers/bind.js";
import Axios from "./core/Axios.js";
import mergeConfig from "./core/mergeConfig.js";
import defaults from "./defaults/index.js";
import formDataToJSON from "./helpers/formDataToJSON.js";
import CanceledError from "./cancel/CanceledError.js";
import CancelToken from "./cancel/CancelToken.js";
import isCancel from "./cancel/isCancel.js";
import { VERSION } from "./env/data.js";
import toFormData from "./helpers/toFormData.js";
import AxiosError from "../lib/core/AxiosError.js";
import spread from "./helpers/spread.js";
import isAxiosError from "./helpers/isAxiosError.js";

/**
 * Create an instance of Axios
 *
 * @param {Object} defaultConfig The default config for the instance
 *
 * @returns {Axios} A new instance of Axios
 */
function createInstance(defaultConfig) {
  const context = new Axios(defaultConfig);
  const instance = bind(Axios.prototype.request, context);

  // Copy axios.prototype to instance
  // æ‹·è´åŸå‹åˆ°å®ä¾‹
  utils.extend(instance, Axios.prototype, context, { allOwnKeys: true });

  // Copy context to instance
  // æ‹·è´ä¸Šä¸‹æ–‡åˆ°å®ä¾‹
  utils.extend(instance, context, { allOwnKeys: true });

  // Factory for creating new instances
  // ç”¨äºåˆ›å»ºæ–°å®ä¾‹çš„å·¥å‚
  instance.create = function create(instanceConfig) {
    return createInstance(mergeConfig(defaultConfig, instanceConfig));
  };

  return instance;
}

// Create the default instance to be exported
// ä½¿ç”¨é»˜è®¤é…ç½®åˆ›å»ºå®ä¾‹
const axios = createInstance(defaults);

// Expose Axios class to allow class inheritance
// æš´éœ²Axiosç±»ï¼Œå…è®¸ç±»è¢«ç»§æ‰¿
axios.Axios = Axios;

// Expose Cancel & CancelToken
axios.CanceledError = CanceledError;
axios.CancelToken = CancelToken;
axios.isCancel = isCancel;
axios.VERSION = VERSION; // gulpçš„envä»»åŠ¡ä¼šå°†package.jsonçš„ç‰ˆæœ¬ä¿¡æ¯è¯»å–å¹¶å†™å…¥ ./lib/env/data.jsï¼Œè§ä¸‹é¢ä»£ç ï¼š
// const env = gulp.task('env', async function () {
//   var npm = JSON.parse(await fs.readFile('package.json'));

//   await fs.writeFile('./lib/env/data.js', Object.entries({
//     VERSION: npm.version
//   }).map(([key, value]) => {
//     return `export const ${key} = ${JSON.stringify(value)};`
//   }).join('\n'));
// });
axios.toFormData = toFormData;

// Expose AxiosError class
// æš´éœ²AxuosErroré”™è¯¯ç±»
axios.AxiosError = AxiosError;

// alias for CanceledError for backward compatibility
// CanceledErrorçš„åˆ«åç”¨äºå‘åå…¼å®¹
axios.Cancel = axios.CanceledError;

// Expose all/spread
// æš´éœ²å¹¶å‘
axios.all = function all(promises) {
  return Promise.all(promises);
};
// æš´éœ²spread
axios.spread = spread; // ä½¿ç”¨å°¾éƒ¨è°ƒç”¨æŸ¯é‡ŒåŒ–ï¼Œæ‰§è¡Œçš„ç»“æœè¿˜æ˜¯ä¸€ä¸ªå‡½æ•°

// Expose isAxiosError
// æš´éœ²åˆ¤æ–­AxiosErrorçš„æ–¹æ³•
axios.isAxiosError = isAxiosError;

axios.formToJSON = (thing) => {
  // è°ƒç”¨å·¥å…·ï¼Œå°†thingè¿›è¡ŒjsonåŒ–
  return formDataToJSON(utils.isHTMLForm(thing) ? new FormData(thing) : thing);
};

export default axios;
```

å…¶ä»–ç»†èŠ‚ä¸çœ‹

## è¿è¡Œ sandbox

```shell
yarn start
```

```bash

ğŸ‘‘ ~/Desktop/axios git:(v1.x) âœ— $ yarn start
yarn run v1.4.0
$ node ./sandbox/server.js
Listening on localhost:3009...
[Thu Jun 23 2022 16:16:31 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)] GET /
file:///Users/haotian/Desktop/axios/sandbox/server.js:14
  fs.createReadStream(path.join(__dirname, file)).pipe(res);
                                ^

ReferenceError: __dirname is not defined
    at pipeFileToResponse (file:///Users/haotian/Desktop/axios/sandbox/server.js:14:33)
    at Server.<anonymous> (file:///Users/haotian/Desktop/axios/sandbox/server.js:30:5)
    at Server.emit (node:events:390:28)
    at parserOnIncoming (node:_http_server:951:12)
    at HTTPParser.parserOnHeadersComplete (node:_http_common:128:17)
error An unexpected error occurred: "Command failed.\nExit code: 1\nCommand: sh\nArguments: -c node ./sandbox/server.js\nDirectory: /Users/haotian/Desktop/axios\nOutput:\n".
info If you think this is a bug, please open a bug report with the information provided in "/Users/haotian/Desktop/axios/yarn-error.log".
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.

```

ä¿®æ”¹

```js
const __filename = url.fileURLToPath(import.meta.url); // å¢åŠ è¿™è¡Œ @see https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/import.meta
const __dirname = path.dirname(__filename); // å¢åŠ è¿™è¡Œ

function pipeFileToResponse(res, file, type) {
  if (type) {
    res.writeHead(200, {
      "Content-Type": type,
    });
  }

  fs.createReadStream(path.join(__dirname, file)).pipe(res);
}
```

<img src="http://t-blog-images.aijs.top/img/20220623162402.webp" />

## core ç›®å½•

## axios æ‰§è¡Œæµç¨‹

æ‰§è¡Œæµç¨‹

å…ˆçœ‹çœ‹æ•´ä½“æ‰§è¡Œæµç¨‹ï¼Œæœ‰å¤§ä½“çš„æ¦‚å¿µï¼Œåé¢ä¼šç»†è¯´æ•´ä½“æµç¨‹æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

1. axios.create åˆ›å»ºå•ç‹¬å®ä¾‹ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ axios å®ä¾‹(axios/axios.getâ€¦)
2. request æ–¹æ³•æ˜¯å…¥å£ï¼Œaxios/axios.get ç­‰è°ƒç”¨éƒ½ä¼šèµ°è¿› request è¿›è¡Œå¤„ç†
3. è¯·æ±‚æ‹¦æˆªå™¨
4. è¯·æ±‚æ•°æ®è½¬æ¢å™¨ï¼Œå¯¹ä¼ å…¥çš„å‚æ•° data å’Œ header åšæ•°æ®å¤„ç†ï¼Œæ¯”å¦‚ JSON.stringify(data)
5. é€‚é…å™¨ï¼Œåˆ¤æ–­æ˜¯æµè§ˆå™¨ç«¯è¿˜æ˜¯ node ç«¯ï¼Œæ‰§è¡Œä¸åŒçš„æ–¹æ³•
6. å“åº”æ•°æ®è½¬æ¢å™¨ï¼Œå¯¹æœåŠ¡ç«¯çš„æ•°æ®è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚ JSON.parse(data)
7. å“åº”æ‹¦æˆªå™¨ï¼Œå¯¹æœåŠ¡ç«¯æ•°æ®åšå¤„ç†ï¼Œæ¯”å¦‚ token å¤±æ•ˆé€€å‡ºç™»é™†ï¼ŒæŠ¥é”™ dialog æç¤º
8. è¿”å›æ•°æ®ç»™å¼€å‘è€…

<img src="http://t-blog-images.aijs.top/img/20220623165311.webp"/>

## å…¥å£æ–‡ä»¶

`file:lib/axios.js`

ä»ä¸‹é¢è¿™æ®µä»£ç å¯ä»¥å¾—å‡ºï¼Œå¯¼å‡ºçš„ axios å°±æ˜¯å®ä¾‹åŒ–åçš„å¯¹è±¡ï¼Œè¿˜åœ¨å…¶ä¸ŠæŒ‚è½½ create æ–¹æ³•ï¼Œä»¥ä¾›åˆ›å»ºç‹¬ç«‹å®ä¾‹ï¼Œä»è€Œè¾¾åˆ°å®ä¾‹ä¹‹é—´äº’ä¸å½±å“ï¼Œäº’ç›¸éš”ç¦»ã€‚

```js
...
// åˆ›å»ºå®ä¾‹è¿‡ç¨‹çš„æ–¹æ³•
functioncreateInstance(defaultConfig) {return instance;}// å®ä¾‹åŒ–
var axios = createInstance(defaults);// åˆ›å»ºç‹¬ç«‹çš„å®ä¾‹ï¼Œéš”ç¦»ä½œç”¨åŸŸ
axios.create = functioncreate(instanceConfig) {return createInstance(mergeConfig(axios.defaults, instanceConfig));};...
// å¯¼å‡ºå®ä¾‹
module.exports = axios; // å¯èƒ½å¤§å®¶å¯¹ createInstance æ–¹æ³•æ„Ÿåˆ°å¥½å¥‡ï¼Œä¸‹é¢ä¸€æ¢ç©¶ç«Ÿã€‚

functioncreateInstance(defaultConfig) {
  // å®ä¾‹åŒ–ï¼Œåˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡
var context = new Axios(defaultConfig);
// å¹³æ—¶è°ƒç”¨çš„ get/post ç­‰ç­‰è¯·æ±‚ï¼Œåº•å±‚éƒ½æ˜¯è°ƒç”¨ request æ–¹æ³•
// å°† request æ–¹æ³•çš„ this æŒ‡å‘ context(ä¸Šä¸‹æ–‡)ï¼Œå½¢æˆæ–°çš„å®ä¾‹
var instance = bind(Axios.prototype.request, context);
// Axios.prototype ä¸Šçš„æ–¹æ³• (get/post...)æŒ‚è½½åˆ°æ–°çš„å®ä¾‹ instance ä¸Šï¼Œ
// å¹¶ä¸”å°†åŸå‹æ–¹æ³•ä¸­ this æŒ‡å‘
context utils.extend(instance, Axios.prototype, context);
// Axios å±æ€§å€¼æŒ‚è½½åˆ°æ–°çš„å®ä¾‹ instance ä¸Š
// å¼€å‘ä¸­æ‰èƒ½ä½¿ç”¨ axios.default/interceptors
utils.extend(instance, context);return instance;}
// ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å¾—å‡ºï¼ŒAxios ä¸æ˜¯ç®€å•çš„åˆ›å»ºå®ä¾‹ contextï¼Œè€Œä¸”è¿›è¡Œä¸€ç³»åˆ—çš„ä¸Šä¸‹æ–‡ç»‘å®šå’Œå±æ€§æ–¹æ³•æŒ‚è½½ï¼Œä»è€Œå»æ”¯æŒ axios()ï¼Œä¹Ÿæ”¯æŒ axios.get() ç­‰ç­‰ç”¨æ³•ï¼›
```

createInstance å‡½æ•°æ˜¯ä¸€ä¸ªæ ¸å¿ƒå…¥å£ï¼Œæˆ‘ä»¬åœ¨æŠŠä¸Šé¢æµç¨‹æ¢³ç†ä¸€ä¸‹ï¼š

1. é€šè¿‡æ„é€ å‡½æ•° Axios åˆ›å»ºå®ä¾‹ contextï¼Œä½œä¸ºä¸‹é¢ request æ–¹æ³•çš„ä¸Šä¸‹æ–‡ï¼ˆthis æŒ‡å‘ï¼‰
2. å°† Axios.prototype.request æ–¹æ³•ä½œä¸ºå®ä¾‹ä½¿ç”¨ï¼Œå¹¶æŠŠ this æŒ‡å‘ contextï¼Œå½¢æˆæ–°çš„å®ä¾‹ instance
3. å°†æ„é€ å‡½æ•° Axios.prototype ä¸Šçš„æ–¹æ³•æŒ‚è½½åˆ°æ–°çš„å®ä¾‹ instance ä¸Šï¼Œç„¶åå°†åŸå‹å„ä¸ªæ–¹æ³•ä¸­çš„ this æŒ‡å‘ contextï¼Œå¼€å‘ä¸­æ‰èƒ½ä½¿ç”¨ axios.get/postâ€¦ ç­‰ç­‰
4. å°†æ„é€ å‡½æ•° Axios çš„å®ä¾‹å±æ€§æŒ‚è½½åˆ°æ–°çš„å®ä¾‹ instance ä¸Šï¼Œæˆ‘ä»¬å¼€å‘ä¸­æ‰èƒ½ä½¿ç”¨ä¸‹é¢å±æ€§ axios.default.baseUrl = 'https://â€¦'axios.interceptors.request.use(resolve,reject)
   å¤§å®¶å¯èƒ½å¯¹ä¸Šé¢ç¬¬ 2 ç‚¹ request æ–¹æ³•æ„Ÿåˆ°å¥½å¥‡ï¼ŒcreateInstance æ–¹æ³•æ˜æ˜å¯ä»¥å†™ä¸€è¡Œä»£ç  return new Axios() å³å¯ï¼Œä¸ºä»€ä¹ˆå¤§è´¹å‘¨ç« ä½¿ç”¨ request æ–¹æ³•ç»‘å®šæ–°å®ä¾‹ï¼Œå…¶å®å°±åªæ˜¯ä¸ºäº†æ”¯æŒ axios() å†™æ³•ï¼Œå¼€å‘è€…å¯ä»¥å†™å°‘å‡ è¡Œä»£ç ã€‚ã€‚ã€‚

## é»˜è®¤é…ç½®

`file:lib/defaults.js`

ä» createInstance æ–¹æ³•è°ƒç”¨å‘ç°æœ‰ä¸ªé»˜è®¤é…ç½®ï¼Œä¸»è¦æ˜¯å†…ç½®çš„å±æ€§å’Œæ–¹æ³•ï¼Œå¯å¯¹å…¶è¿›è¡Œè¦†ç›–

```js
var defaults = {
  ...
  // è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸è¶…æ—¶
  timeout: 0,
   // è¯·æ±‚æ•°æ®è½¬æ¢å™¨
  transformRequest: [functiontransformRequest(data, headers) {...}],
  // å“åº”æ•°æ®è½¬æ¢å™¨
  transformResponse: [functiontransformResponse(data) {...}], ...};
  ...
```

ä¸»è¦æœ‰ä¸¤ç‚¹ï¼š

1. é…ç½®ï¼šå¤–éƒ¨ä¼ å…¥ï¼Œå¯è¦†ç›–å†…éƒ¨é»˜è®¤é…ç½®
2. æ‹¦æˆªå™¨ï¼šå®ä¾‹åï¼Œå¼€å‘è€…å¯é€šè¿‡ use æ–¹æ³•æ³¨å†ŒæˆåŠŸå’Œå¤±è´¥çš„é’©å­å‡½æ•°ï¼Œæ¯”å¦‚

```js
axios.interceptors.request.use((config)=>config,(error)=>error);
functionAxios(instanceConfig) {
  // é…ç½®
  this.defaults = instanceConfig;
  // æ‹¦æˆªå™¨å®ä¾‹
  this.interceptors = {request: new InterceptorManager(),response: new InterceptorManager() };}
```

åœ¨çœ‹çœ‹åŸå‹æ–¹æ³• request åšäº†ä»€ä¹ˆ

æ”¯æŒå¤šç±»å‹ä¼ å‚
é…ç½®ä¼˜å…ˆçº§å®šä¹‰
é€šè¿‡ promise é“¾å¼è°ƒç”¨ï¼Œä¾æ¬¡é¡ºåºæ‰§è¡Œ

```js
// ä¼ªä»£ç 
Axios.prototype.request = functionrequest(config) {
  // ä¸ºäº†æ”¯æŒ
  request(url, {...}), request({url, ...})if (typeof config === 'string') { config = arguments[1] || {}; config.url = arguments[0]; } else { config = config || {}; }
  // é…ç½®ä¼˜å…ˆçº§ï¼š è°ƒç”¨æ–¹æ³•çš„é…ç½® > å®ä¾‹åŒ– axios çš„é…ç½® > é»˜è®¤é…ç½®
  // ä¸¾ä¸ªä¾‹å­ï¼Œç±»ä¼¼ï¼š
  axios.get(url, {}) > axios.create(url, {}) > å†…éƒ¨é»˜è®¤è®¾ç½® config = mergeConfig(this.defaults, config);
  // æ‹¦æˆªå™¨ï¼ˆè¯·æ±‚å’Œå“åº”ï¼‰
  var requestInterceptorChain = [{fulfilled: interceptor.request.fulfilled,rejected: interceptor.request.rejected }];
  var responseInterceptorChain = [{fulfilled: interceptor.response.fulfilled,rejected: interceptor.response.rejected }];
  var promise;// å½¢æˆä¸€ä¸ª promise é“¾æ¡çš„æ•°ç»„
  var chain = [].concat(requestInterceptorChain, chain, responseInterceptorChain);
  // ä¼ å…¥é…ç½®
  promise = Promise.resolve(config);
  // å½¢æˆ promise é“¾æ¡è°ƒç”¨
   while (chain.length) { promise = promise.then(chain.shift(), chain.shift()); } ... return promise;};
```

é€šè¿‡å¯¹æ•°ç»„çš„éå†ï¼Œå½¢æˆä¸€æ¡å¼‚æ­¥çš„ promise è°ƒç”¨é“¾ï¼Œæ˜¯ axios å¯¹ promise çš„å·§å¦™è¿ç”¨ï¼Œç”¨ä¸€å¼ å›¾è¡¨ç¤º

<img src="http://t-blog-images.aijs.top/img/20220623165416.webp" />

## æ‹¦æˆªå™¨

`file:lib/core/InterceptorManager.js`

ä¸Šé¢è¯´åˆ°çš„ promise è°ƒç”¨é“¾ï¼Œé‡Œé¢æ¶‰åŠåˆ°æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªå™¨æ¯”è¾ƒç®€å•ï¼ŒæŒ‚è½½ä¸€ä¸ªå±æ€§å’Œä¸‰ä¸ªåŸå‹æ–¹æ³•

- handler: å­˜æ”¾ use æ³¨å†Œçš„å›è°ƒå‡½æ•°
- use: æ³¨å†ŒæˆåŠŸå’Œå¤±è´¥çš„å›è°ƒå‡½æ•°
- eject: åˆ é™¤æ³¨å†Œè¿‡çš„å‡½æ•°
- forEach: éå†å›è°ƒå‡½æ•°ï¼Œä¸€èˆ¬å†…éƒ¨ä½¿ç”¨å¤šï¼Œæ¯”å¦‚ï¼špromise è°ƒç”¨é“¾é‚£ä¸ªæ–¹æ³•é‡Œï¼Œå¾ªç¯éå†å›è°ƒå‡½æ•°ï¼Œå­˜æ”¾åˆ° promise è°ƒç”¨é“¾çš„æ•°ç»„ä¸­

```js
class InterceptorManager {
  constructor() {
    this.handlers = [];
  }

  /**
   * Add a new interceptor to the stack
   * // æ³¨å†ŒæˆåŠŸå’Œå¤±è´¥çš„å›è°ƒå‡½æ•°
   * @param {Function} fulfilled The function to handle `then` for a `Promise`
   * @param {Function} rejected The function to handle `reject` for a `Promise`
   *
   * @return {Number} An ID used to remove interceptor later
   */
  use(fulfilled, rejected, options) {
    this.handlers.push({
      fulfilled,
      rejected,
      synchronous: options ? options.synchronous : false,
      runWhen: options ? options.runWhen : null,
    });
    return this.handlers.length - 1;
  }

  /**
   * Remove an interceptor from the stack
   * // åˆ é™¤æ³¨å†Œè¿‡çš„å‡½æ•°
   * @param {Number} id The ID that was returned by `use`
   *
   * @returns {Boolean} `true` if the interceptor was removed, `false` otherwise
   */
  eject(id) {
    if (this.handlers[id]) {
      this.handlers[id] = null;
    }
  }

  /**
   * Clear all interceptors from the stack
   * è°ƒç”¨æ ˆæ¸…ç©ºæ‰€æœ‰æ‹¦æˆªå™¨
   * @returns {void}
   */
  clear() {
    if (this.handlers) {
      this.handlers = [];
    }
  }

  /**
   * Iterate over all the registered interceptors
   *
   * This method is particularly useful for skipping over any
   * interceptors that may have become `null` calling `eject`.
   * // éå†å›è°ƒå‡½æ•°ï¼Œä¸€èˆ¬å†…éƒ¨ä½¿ç”¨å¤š
   * @param {Function} fn The function to call for each interceptor
   *
   * @returns {void}
   */
  forEach(fn) {
    utils.forEach(this.handlers, function forEachHandler(h) {
      if (h !== null) {
        fn(h);
      }
    });
  }
}

export default InterceptorManager;
```

## dispatchRequest

`file: lib/core/dispatchRequest.js`

ä¸Šé¢è¯´åˆ°çš„ promise è°ƒç”¨é“¾ä¸­çš„ dispatchRequest æ–¹æ³•ï¼Œä¸»è¦åšäº†ä»¥ä¸‹æ“ä½œï¼š
ä»¥ `transformData.call`æ–¹å¼è°ƒç”¨

- transformRequest: å¯¹ config ä¸­çš„ data è¿›è¡ŒåŠ å·¥ï¼Œæ¯”å¦‚å¯¹ post è¯·æ±‚çš„ data è¿›è¡Œå­—ç¬¦ä¸²åŒ– ï¼ˆJSON.stringify(data)ï¼‰
- adapterï¼šé€‚é…å™¨ï¼ŒåŒ…å«æµè§ˆå™¨ç«¯ xhr å’Œ node ç«¯çš„ http
- transformResponse: å¯¹æœåŠ¡ç«¯å“åº”çš„æ•°æ®è¿›è¡ŒåŠ å·¥ï¼Œæ¯”å¦‚ JSON.parse(data)

dispatchRequest å±€éƒ¨å›¾

<img src="http://t-blog-images.aijs.top/img/20220623165506.webp" width=300 height=/>

```js
module.exports = functiondispatchRequest(config) {
  ...
  // transformRequest æ–¹æ³•ï¼Œä¸Šä¸‹æ–‡ç»‘å®š configï¼Œå¯¹ data å’Œ headers è¿›è¡ŒåŠ å·¥
  config.data = transformData.call( config,
  // ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå³ this æŒ‡å‘ config.data,
  // è¯·æ±‚ body å‚æ•° config.headers,
  // è¯·æ±‚å¤´ config.transformRequest
  // è½¬æ¢æ•°æ®æ–¹æ³•
  );
  // adapter æ˜¯ä¸€ä¸ªé€‚é…å™¨ï¼ŒåŒ…å«æµè§ˆå™¨ç«¯ xhr å’Œ node ç«¯çš„ http
  // å†…ç½®æœ‰ adapterï¼Œä¹Ÿå¯å¤–éƒ¨è‡ªå®šä¹‰å»å‘èµ· ajax è¯·æ±‚
  var adapter = config.adapter || defaults.adapter;return adapter(config).then(
    functiononAdapterResolution(response) {
    // transformResponse æ–¹æ³•ï¼Œä¸Šä¸‹æ–‡ç»‘å®š configï¼Œå¯¹ data å’Œ headers è¿›è¡ŒåŠ å·¥
      response.data = transformData.call( config,
      // ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå³ this æŒ‡å‘
      response.data, // æœåŠ¡ç«¯å“åº”çš„ data
      config.transformResponse // è½¬æ¢æ•°æ®æ–¹æ³•
      );

      response.headers, // æœåŠ¡ç«¯å“åº”çš„ headers

      return response;
     },
    functiononAdapterRejection(reason) {
     ...
     return Promise.reject(reason);
    });
  };
```

## æ•°æ®è½¬æ¢å™¨

`file:lib/core/transformData.js`

ä¸Šé¢è¯´åˆ°çš„æ•°æ®è½¬æ¢å™¨ï¼Œæ¯”è¾ƒå¥½ç†è§£ï¼Œæºç å¦‚ä¸‹

```js
// fns æ–¹æ³•å³ï¼ˆè¯·æ±‚æˆ–å“åº”ï¼‰æ•°æ®è½¬æ¢å™¨æ–¹æ³•ï¼Œåœ¨åˆšå¼€å§‹ defaults æ–‡ä»¶é‡Œå®šä¹‰çš„é»˜è®¤é…ç½®ï¼Œä¹Ÿå¯å¤–éƒ¨è‡ªå®šä¹‰æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š

/**
 * Transform the data for a request or a response
 * è½¬æ¢è¯·æ±‚æˆ–å“åº”çš„æ•°æ®
 * @param {Array|Function} fns ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ–¹æ³•è½¬æ¢å™¨æ–¹æ³•
 * @param {?Object} response The response object
 *
 * @returns {*} The resulting transformed data
 */
export default function transformData(fns, response) {
  const config = this || defaults;
  const context = response || config;
  const headers = AxiosHeaders.from(context.headers);
  let data = context.data;

  utils.forEach(fns, function transform(fn) {
    data = fn.call(
      config,
      data,
      headers.normalize(),
      response ? response.status : undefined
    );
  });

  headers.normalize();

  return data;
}
```

## Axios

`file: lib/defaults.js`

```js

const defaults = {
  ...
  // è¿”å›è½¬åŒ–åçš„è¯·æ±‚å‚æ•°
  transformRequest: [function transformRequest(data, headers) {
    const contentType = headers.getContentType() || '';
    const hasJSONContentType = contentType.indexOf('application/json') > -1;
    const isObjectPayload = utils.isObject(data);

    if (isObjectPayload && utils.isHTMLForm(data)) {
      data = new FormData(data);
    }

    const isFormData = utils.isFormData(data);

    if (isFormData) {
      if (!hasJSONContentType) {
        return data;
      }
      return hasJSONContentType ? JSON.stringify(formDataToJSON(data)) : data;
    }

    if (utils.isArrayBuffer(data) ||
      utils.isBuffer(data) ||
      utils.isStream(data) ||
      utils.isFile(data) ||
      utils.isBlob(data)
    ) {
      return data;
    }
    if (utils.isArrayBufferView(data)) {
      return data.buffer;
    }
    if (utils.isURLSearchParams(data)) {
      headers.setContentType('application/x-www-form-urlencoded;charset=utf-8', false);
      return data.toString();
    }

    let isFileList;

    if (isObjectPayload) {
      if (contentType.indexOf('application/x-www-form-urlencoded') > -1) {
        return toURLEncodedForm(data, this.formSerializer).toString();
      }

      if ((isFileList = utils.isFileList(data)) || contentType.indexOf('multipart/form-data') > -1) {
        const _FormData = this.env && this.env.FormData;

        return toFormData(
          isFileList ? {'files[]': data} : data,
          _FormData && new _FormData(),
          this.formSerializer
        );
      }
    }

    if (isObjectPayload || hasJSONContentType ) {
      headers.setContentType('application/json', false);
      return stringifySafely(data);
    }

    return data;
  }],
  // è¿”å›è½¬åŒ–åçš„å“åº”æ•°æ®
  transformResponse: [function transformResponse(data) {
    const transitional = this.transitional || defaults.transitional;
    const forcedJSONParsing = transitional && transitional.forcedJSONParsing;
    const JSONRequested = this.responseType === 'json';

    if (data && utils.isString(data) && ((forcedJSONParsing && !this.responseType) || JSONRequested)) {
      const silentJSONParsing = transitional && transitional.silentJSONParsing;
      const strictJSONParsing = !silentJSONParsing && JSONRequested;

      try {
        return JSON.parse(data); // è§£ææ•°æ®
      } catch (e) {
        if (strictJSONParsing) {
          if (e.name === 'SyntaxError') {
            throw AxiosError.from(e, AxiosError.ERR_BAD_RESPONSE, this, null, this.response);
          }
          throw e;
        }
      }
    }

    return data;
  }],


};
```

## é€‚é…å™¨

`file:lib/defaults.js`

ä¸»è¦åŒ…å«ä¸¤éƒ¨åˆ†æºç ï¼Œå³æµè§ˆå™¨ç«¯ xhr å’Œ node ç«¯çš„ http è¯·æ±‚ï¼Œé€šè¿‡åˆ¤æ–­ç¯å¢ƒï¼Œæ‰§è¡Œä¸åŒç«¯çš„ apiã€‚

```js
import utils from "../utils.js";
import httpAdapter from "./http.js";
import xhrAdapter from "./xhr.js";

const adapters = {
  http: httpAdapter,
  xhr: xhrAdapter,
};

export default {
  getAdapter: (nameOrAdapter) => {
    if (utils.isString(nameOrAdapter)) {
      const adapter = adapters[nameOrAdapter];

      if (!nameOrAdapter) {
        throw Error(
          utils.hasOwnProp(nameOrAdapter)
            ? `Adapter '${nameOrAdapter}' is not available in the build`
            : `Can not resolve adapter '${nameOrAdapter}'`
        );
      }

      return adapter;
    }

    if (!utils.isFunction(nameOrAdapter)) {
      throw new TypeError("adapter is not a function");
    }

    return nameOrAdapter;
  },
  adapters,
};

// æ³¨ï¼š/axios/lib/core/dispatchRequest.js
// const adapter = config.adapter || defaults.adapter; ä¸­è°ƒç”¨ defaults.adapter
// file: /axios/lib/defaults/index.js
// export const default = {
//   adapter: getDefaultAdapter(),
// }
```

å¯¹å¤–æä¾›ç»Ÿä¸€ apiï¼Œä½†åº•å±‚å…¼å®¹æµè§ˆå™¨ç«¯å’Œ node ç«¯ï¼Œç±»ä¼¼ sdkï¼Œåº•å±‚æ›´æ”¹ä¸å½±å“ä¸Šå±‚ apiï¼Œä¿æŒå‘åå…¼å®¹

## å‘èµ·è¯·æ±‚

`file: lib/adapters/xhr.js`
å¹³æ—¶ç”¨å¾—æ¯”è¾ƒå¤šçš„æ˜¯æµè§ˆå™¨ç«¯ï¼Œè¿™é‡Œåªè®² XMLHttpRequest çš„å°è£…ï¼Œnode ç«¯æœ‰å…´è¶£çš„åŒå­¦è‡ªè¡ŒæŸ¥çœ‹æºç (lib/adapters/http.js)

ç®€æ˜“ç‰ˆæµç¨‹å›¾è¡¨ç¤ºå¤§è‡´å†…å®¹ï¼š

<a href="http://t-blog-images.aijs.top/img/20220623172736.webp" target="_blank" ></a>

æ³¨æ„ï¼šæ–°ç‰ˆæœ¬æœ‰æ”¹åŠ¨

- setCancelToken æ²¡å•¦ï¼Œæœ‰ cancelToken å’Œ signal
- isSetCookie æ²¡æœ‰è¿™ä¸ª
- `onreadystatechange` ä¸ä¸€å®šæœ‰, `onloadend`æ–¹æ³•ä¸€å®šä¼šè¢«è°ƒç”¨

```js
if ("onloadend" in request) {
  // Use onloadend if available
  request.onloadend = onloadend;
} else {
  // Listen for ready state to emulate onloadend
  request.onreadystatechange = function handleLoad() {
    if (!request || request.readyState !== 4) {
      return;
    }

    // The request errored out and we didn't get a response, this will be
    // handled by onerror instead
    // With one exception: request that using file: protocol, most browsers
    // will return status as 0 even though it's a successful request
    if (
      request.status === 0 &&
      !(request.responseURL && request.responseURL.indexOf("file:") === 0)
    ) {
      return;
    }
    // readystate handler is calling before onerror or ontimeout handlers,
    // so we should call onloadend on the next 'tick'
    setTimeout(onloadend);
  };
}
```

## å‚è€ƒé“¾æ¥

<a href="https://baijiahao.baidu.com/s?id=1704404768648603231&wfr=spider&for=pc&searchword=axios%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" target="_blank" >Axios æºç è§£æ-å®Œæ•´ç¯‡</a>

<a href="https://blog.csdn.net/qq_27053493/article/details/97462300" target="_blank" >ä¸€æ­¥ä¸€æ­¥è§£æ Axios æºç ï¼Œä»å…¥é—¨åˆ°åŸç†</a>

<a href="https://www.codingsky.com/doc/2022/4/2/433.html" target="_blank" >axiosæºç ä¸­çš„10å¤šä¸ªå·¥å…·å‡½æ•°ï¼Œå€¼å¾—ä¸€å­¦~</a>